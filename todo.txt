已经为你整理好了。你可以直接将下面的内容保存为 `ZULF_Optimizer_Specification.md`（或 `.txt`），然后直接上传给你的 Coding Agent。

---

# ZULF-NMR 随机游走联合优化器需求文档

## 1. 核心目标

利用受限随机游走（Constrained Random Walk）算法，在**自旋动力学模拟参数**（J-coupling, T2线宽）与**信号处理参数**（SG平滑、截断范围）组成的联合空间中搜索最优解，使模拟得到的 Spectrum 与实验处理后的 Spectrum 达到最高吻合度。

## 2. 输入输出定义

* **Input (Experimental):** 原始时域或频域实验数据。
* **Input (Initial Guess):** 
    * J-coupling 初始中心值、边界范围、弹簧约束强度。
    * SG 卷积点数 初始值。
    * 截断点 初始值。
    * T2 线宽 (新) 初始值。
* **Output:** 最优参数组合、最终对比谱线图、优化过程的 Cost 曲线。

## 3. 随机游走变量控制 (混合约束机制)

每一轮迭代，程序需对以下变量进行扰动，并应用 "Center + Elasticity + Bounds" 混合约束：

* **物理变量 (J-coupling):** 
    * 连续浮点数，使用高斯扰动。
    * **约束:** 硬截断 (Hard Clip) 保证不越界 + 软弹簧 (Soft Penalty) 将参数拉向初始中心。
* **物理变量 (T2 Linewidth):** (新增)
    * 连续浮点数，影响谱线胖瘦。有助于降低 L2 误差。
* **处理变量 (SG Points):** 离散奇数，步长为 2。
* **处理变量 (Truncation):** 整数索引，步长自定（如 10）。

## 4. 联合吻合度评价函数 (Cost Function)

这是程序的核心，Cost 由误差分量和约束惩罚组成：
$$ Cost_{total} = (w_1 PosErr + w_2 L2Err + w_3 HeightErr) + \sum w_{pen} (\theta - \theta_{center})^2 $$

### A. 拟合误差分量

1. **峰位置误差 (PosErr):** (权重建议: 阶段性调整，初期 1.0)
    * **逻辑:** 主峰频率对齐。
    * **目的:** 锁定物理耦合常数 J。

2. **频谱二范数误差 (L2Err):** (权重建议: 0.3)
    * **逻辑:** 归一化后逐点残差平方和。
    * **目的:** 优化波形、线宽 ($T_2$) 和平滑度 (SG)。

3. **相对高度误差 (HeightErr):** (权重建议: 0.1)
    * **逻辑:** 强峰比例 。
    * **目的:** 锁定对称性。

### B. 约束惩罚分量 (Elasticity)

* 对于偏离中心值的参数，施加二次方惩罚，防止参数在无梯度区域发生剧烈漂移（Regularization）。

## 5. 高级功能规划

* **分阶段优化 (Staged Optimization):** 先只优化位置 (PosErr) 锁定 J 值，再加入 L2 和 Height 优化线宽和细节。
* **断点续传 (Checkpointing):** 每 N 次迭代自动保存 `best_params` 到 JSON，防止中断丢失进度。
* **并行游走 (Parallel Walkers):** 多线程同时探索，提高全局搜索能力 (可选)。
* **基线校正 (Baseline):** 预处理时自动扣除实验谱基线。

---




## 5. 给 Coding Agent 的实现建议 (Coding Notes)

* **数据对齐:** 在计算 Cost 之前，务必确保模拟谱线和实验谱线在相同的频率轴（Frequency Axis）上。如果点数不一致，请使用 `np.interp` 进行插值。
* **贪婪搜索逻辑:** ```python
if new_cost < current_cost:
accept_new_parameters()
else:
# 可选：以小概率接受差解（模拟退火）以防止陷入局部最优
```

```


* **实时绘图:** 建议每 50 次迭代更新一次 Matplotlib 图表，显示两条谱线的重叠情况，方便人工观察优化进度。

---

**下一步建议：**
你可以尝试先给 （位置）分配 0.6，（形态）分配 0.3，（高度比）分配 0.1。如果 Agent 写出的代码在运行中“找不到峰”，可以调整 `find_peaks` 的 `height` 参数。

需要我为你直接生成一段基于此逻辑的 **Python 伪代码** 供参考吗？