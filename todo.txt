已经为你整理好了。你可以直接将下面的内容保存为 `ZULF_Optimizer_Specification.md`（或 `.txt`），然后直接上传给你的 Coding Agent。

---

# ZULF-NMR 随机游走联合优化器需求文档

## 1. 核心目标

利用随机游走（Random Walk）算法，在**自旋动力学模拟参数**（J-coupling）与**信号处理参数**（SG平滑、截断范围）组成的联合空间中搜索最优解，使模拟得到的 Spectrum 与实验处理后的 Spectrum 达到最高吻合度。

## 2. 输入输出定义

* **Input (Experimental):** 原始时域或频域实验数据。
* **Input (Initial Guess):**  耦合初始值列表、SG 卷积点数初始值、截断点初始值。
* **Output:** 最优参数组合、最终对比谱线图、优化过程的 Cost 曲线。

## 3. 随机游走变量控制

每一轮迭代，程序需对以下变量进行扰动：

* **物理变量 ():** 连续浮点数，使用 `np.random.normal` 进行高斯扰动。
* **处理变量 (SG Points):** 离散奇数，步长为 ，范围需大于 3。
* **处理变量 (Truncation):** 整数索引，步长自定（如 ），需满足 。

## 4. 联合吻合度评价函数 (Cost Function)

这是程序的核心，Cost 由三个加权分量组成：

### 

1. **峰位置误差 (PosErr):**
* **逻辑:** 对模拟和实验谱线使用 `scipy.signal.find_peaks` 提取主峰频率。
* **计算:** 计算对应峰之间的频率偏差平方和 。
* **目的:** 强制  耦合数值对齐物理特征频率。


2. **频谱二范数误差 (L2Err):**
* **逻辑:** 将两条谱线的幅值归一化到 。
* **计算:** 计算两条频谱曲线的逐点残差平方和 。
* **目的:** 优化线宽形态、平滑程度以及整体包络的吻合。


3. **相对高度误差 (HeightErr):**
* **逻辑:** 提取最强的两个峰（Peak A, Peak B），计算比例 。
* **计算:** 。
* **目的:** 在多耦合体系中，利用峰强比例锁定自旋演化的对称性参数。



## 5. 给 Coding Agent 的实现建议 (Coding Notes)

* **数据对齐:** 在计算 Cost 之前，务必确保模拟谱线和实验谱线在相同的频率轴（Frequency Axis）上。如果点数不一致，请使用 `np.interp` 进行插值。
* **贪婪搜索逻辑:** ```python
if new_cost < current_cost:
accept_new_parameters()
else:
# 可选：以小概率接受差解（模拟退火）以防止陷入局部最优
```

```


* **实时绘图:** 建议每 50 次迭代更新一次 Matplotlib 图表，显示两条谱线的重叠情况，方便人工观察优化进度。

---

**下一步建议：**
你可以尝试先给 （位置）分配 0.6，（形态）分配 0.3，（高度比）分配 0.1。如果 Agent 写出的代码在运行中“找不到峰”，可以调整 `find_peaks` 的 `height` 参数。

需要我为你直接生成一段基于此逻辑的 **Python 伪代码** 供参考吗？